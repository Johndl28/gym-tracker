<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Rutinas de Gimnasio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
    .calendar-day { padding: 10px; text-align: center; cursor: pointer; border: 1px solid #ddd; position: relative; }
    .completed { background-color: #10b981; color: white; }
    .completed svg { position: absolute; top: 5px; right: 5px; width: 20px; height: 20px; }
    .selected { border: 2px solid #3b82f6; }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl">
    <h1 class="text-2xl font-bold text-center mb-4">Registro de Rutinas de Gimnasio</h1>
    <div class="flex justify-between mb-4">
      <button id="prevMonth" class="bg-blue-500 text-white px-4 py-2 rounded">Mes Anterior</button>
      <h2 id="currentMonth" class="text-xl font-semibold"></h2>
      <button id="nextMonth" class="bg-blue-500 text-white px-4 py-2 rounded">Mes Siguiente</button>
    </div>
    <div id="calendar" class="calendar-grid mb-4"></div>
    <div id="routineDetails" class="hidden mb-4 p-4 bg-gray-50 rounded">
      <h3 class="text-lg font-semibold">Detalles de la Rutina</h3>
      <p id="routineText" class="text-gray-700"></p>
      <p id="detailsText" class="text-gray-700"></p>
      <p id="caloriesText" class="text-gray-700"></p>
    </div>
    <div class="flex flex-col gap-4 mb-6">
      <select id="routineSelect" class="border p-2 rounded">
        <option value="">Selecciona una rutina</option>
        <option value="Día A - Full Body A + Cardio">Día A - Full Body A + Cardio</option>
        <option value="Día B - Full Body B + Cardio">Día B - Full Body B + Cardio</option>
        <option value="Día C - Tren Superior">Día C - Tren Superior</option>
        <option value="Día D - Tren Inferior">Día D - Tren Inferior</option>
      </select>
      <textarea id="routineDetailsInput" class="border p-2 rounded min-h-[150px]" placeholder="Ingresa detalles de la rutina (ej. Sentadillas: 3 series x 10 rep)"></textarea>
      <input type="number" id="caloriesInput" class="border p-2 rounded" placeholder="Calorías quemadas (kcal)" min="0">
      <label class="flex items-center gap-2">
        <input type="checkbox" id="completedCheckbox" class="h-5 w-5">
        <span>Entrenamiento completado</span>
      </label>
      <button id="saveRoutine" class="bg-green-500 text-white px-4 py-2 rounded">Guardar</button>
    </div>
    <div class="mt-6">
      <h3 class="text-lg font-semibold mb-2">Resumen de Actividades Completadas</h3>
      <div class="flex flex-col sm:flex-row gap-4 mb-4">
        <div>
          <label for="fromMonth" class="block text-sm font-medium">Mes desde:</label>
          <input type="month" id="fromMonth" class="border p-2 rounded">
        </div>
        <div>
          <label for="toMonth" class="block text-sm font-medium">Mes hasta:</label>
          <input type="month" id="toMonth" class="border p-2 rounded">
        </div>
        <button id="exportCsv" class="bg-blue-500 text-white px-4 py-2 rounded self-end">Exportar a CSV</button>
      </div>
      <table id="completedTable" class="w-full border-collapse border border-gray-300">
        <thead>
          <tr class="bg-gray-100">
            <th class="border border-gray-300 p-2">Fecha</th>
            <th class="border border-gray-300 p-2">Calorías Quemadas (kcal)</th>
          </tr>
        </thead>
        <tbody id="completedTableBody"></tbody>
      </table>
    </div>
  </div>
  <script>
    const routineDetailsMap = {
      "Día A - Full Body A + Cardio": "Sentadillas: 3 series x 10 rep\nPress de banca: 3 series x 8 rep\nRemo con barra: 3 series x 10 rep\nPlancha: 3 x 30s\nCardio: 20 min cinta",
      "Día B - Full Body B + Cardio": "Peso muerto: 3 series x 8 rep\nPress militar: 3 series x 10 rep\nDominadas: 3 series x 8 rep\nAbdominales: 3 x 15 rep\nCardio: 15 min elíptica",
      "Día C - Tren Superior": "Press de banca inclinado: 3 series x 10 rep\nCurl de bíceps: 3 series x 12 rep\nFondos en paralelas: 3 series x 10 rep\nElevaciones laterales: 3 series x 12 rep",
      "Día D - Tren Inferior": "Sentadillas hack: 3 series x 10 rep\nPrensa de piernas: 3 series x 12 rep\nZancadas: 3 series x 10 rep\nElevación de talones: 3 series x 15 rep"
    };

    let currentDate = new Date();
    let selectedDay = null;
    let routines = [];

    async function loadCalendar() {
      const monthYear = currentDate.toLocaleString('es-ES', { month: 'long', year: 'numeric' });
      document.getElementById('currentMonth').textContent = monthYear.charAt(0).toUpperCase() + monthYear.slice(1);
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '<div>Dom</div><div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div>';

      const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
      const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();

      for (let i = 0; i < firstDay; i++) {
        calendar.innerHTML += '<div></div>';
      }

      try {
        const response = await fetch('/api/routines');
        routines = await response.json();
      } catch (error) {
        console.error('Error al cargar datos:', error);
        alert('Error al cargar datos');
        routines = [];
      }

      // Llenar el calendario
      for (let day = 1; day <= daysInMonth; day++) {
        const date = `${day.toString().padStart(2, '0')}/${(currentDate.getMonth() + 1).toString().padStart(2, '0')}/${currentDate.getFullYear()}`;
        const routine = routines.find(r => r.date === date);
        const div = document.createElement('div');
        div.className = `calendar-day ${routine && routine.completed ? 'completed' : ''} ${selectedDay === date ? 'selected' : ''}`;
        div.textContent = day;
        if (routine && routine.completed) {
          div.innerHTML += `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M9 16.2l-3.5-3.5a1 1 0 00-1.4 1.4l4.2 4.2a1 1 0 001.4 0l8-8a1 1 0 00-1.4-1.4L9 16.2z"/></svg>`;
        }
        div.onclick = () => selectDay(date, routine);
        calendar.appendChild(div);
      }

      // Llenar la tabla de actividades completadas
      updateCompletedTable();
    }

    function updateCompletedTable() {
      const fromMonth = document.getElementById('fromMonth').value;
      const toMonth = document.getElementById('toMonth').value;
      const tableBody = document.getElementById('completedTableBody');
      tableBody.innerHTML = '';

      // Convertir fechas de filtro a objetos Date
      let fromDate = fromMonth ? new Date(fromMonth + '-01') : null;
      let toDate = toMonth ? new Date(toMonth + '-01') : null;
      if (toDate) {
        toDate.setMonth(toDate.getMonth() + 1); // Incluir todo el mes
        toDate.setDate(0); // Último día del mes
      }

      // Filtrar rutinas completadas
      let filteredRoutines = routines.filter(r => r.completed);
      if (fromDate || toDate) {
        filteredRoutines = filteredRoutines.filter(r => {
          const [day, month, year] = r.date.split('/');
          const routineDate = new Date(`${year}-${month}-${day}`);
          return (!fromDate || routineDate >= fromDate) && (!toDate || routineDate <= toDate);
        });
      }

      if (filteredRoutines.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="2" class="border border-gray-300 p-2 text-center">No hay actividades completadas</td></tr>';
      } else {
        filteredRoutines.forEach(routine => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="border border-gray-300 p-2">${routine.date}</td>
            <td class="border border-gray-300 p-2">${routine.caloriesBurned || 0} kcal</td>
          `;
          tableBody.appendChild(row);
        });
      }
    }

    function exportToCsv() {
      const fromMonth = document.getElementById('fromMonth').value;
      const toMonth = document.getElementById('toMonth').value;
      let fromDate = fromMonth ? new Date(fromMonth + '-01') : null;
      let toDate = toMonth ? new Date(toMonth + '-01') : null;
      if (toDate) {
        toDate.setMonth(toDate.getMonth() + 1);
        toDate.setDate(0);
      }

      let filteredRoutines = routines.filter(r => r.completed);
      if (fromDate || toDate) {
        filteredRoutines = filteredRoutines.filter(r => {
          const [day, month, year] = r.date.split('/');
          const routineDate = new Date(`${year}-${month}-${day}`);
          return (!fromDate || routineDate >= fromDate) && (!toDate || routineDate <= toDate);
        });
      }

      const csvContent = [
        'Fecha,Calorías Quemadas (kcal)',
        ...filteredRoutines.map(r => `${r.date},${r.caloriesBurned || 0}`)
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `actividades_completadas_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    function selectDay(date, routine) {
      selectedDay = date;
      document.querySelectorAll('.calendar-day').forEach(div => div.classList.remove('selected'));
      const dayDiv = Array.from(document.querySelectorAll('.calendar-day')).find(div => div.textContent == date.split('/')[0]);
      if (dayDiv) dayDiv.classList.add('selected');

      const routineDetails = document.getElementById('routineDetails');
      const routineText = document.getElementById('routineText');
      const detailsText = document.getElementById('detailsText');
      const caloriesText = document.getElementById('caloriesText');
      routineDetails.classList.remove('hidden');
      routineText.textContent = routine ? `Rutina: ${routine.routine}` : 'No hay rutina asignada';
      detailsText.textContent = routine && routine.details ? `Detalles: ${routine.details}` : routine ? `Detalles: ${routineDetailsMap[routine.routine] || 'No hay detalles predefinidos'}` : 'No hay detalles';
      caloriesText.textContent = routine && routine.caloriesBurned ? `Calorías quemadas: ${routine.caloriesBurned} kcal` : 'No hay calorías registradas';
      document.getElementById('routineSelect').value = routine ? routine.routine : '';
      document.getElementById('routineDetailsInput').value = routine && routine.details ? routine.details : routine ? routineDetailsMap[routine.routine] || '' : '';
      document.getElementById('caloriesInput').value = routine && routine.caloriesBurned ? routine.caloriesBurned : '';
      document.getElementById('completedCheckbox').checked = routine ? routine.completed : false;
    }

    async function saveRoutine() {
      if (!selectedDay) {
        alert('Selecciona un día');
        return;
      }
      const routine = document.getElementById('routineSelect').value;
      const details = document.getElementById('routineDetailsInput').value || routineDetailsMap[routine] || '';
      const caloriesBurned = parseInt(document.getElementById('caloriesInput').value) || 0;
      const completed = document.getElementById('completedCheckbox').checked;

      try {
        const response = await fetch('/api/routines', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date: selectedDay, routine, details, caloriesBurned, completed })
        });
        const result = await response.json();
        if (response.ok) {
          alert('Rutina guardada');
          loadCalendar();
        } else {
          alert(result.error || 'Error al guardar la rutina');
        }
      } catch (error) {
        console.error('Error al guardar:', error);
        alert('Error al guardar la rutina');
      }
    }

    document.getElementById('routineSelect').onchange = () => {
      const routine = document.getElementById('routineSelect').value;
      document.getElementById('routineDetailsInput').value = routine ? routineDetailsMap[routine] || '' : '';
    };

    document.getElementById('prevMonth').onclick = () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      loadCalendar();
    };
    document.getElementById('nextMonth').onclick = () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      loadCalendar();
    };
    document.getElementById('saveRoutine').onclick = saveRoutine;
    document.getElementById('fromMonth').onchange = updateCompletedTable;
    document.getElementById('toMonth').onchange = updateCompletedTable;
    document.getElementById('exportCsv').onclick = exportToCsv;

    loadCalendar();
  </script>
</body>
</html>
